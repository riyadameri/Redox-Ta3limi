<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المدرسة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            background-color: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .main-content {
            margin-right: 250px;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }
        .nav-pills .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        .nav-pills .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-pills .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #3498db;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .student-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #3498db;
            margin: 0 auto;
        }
        .payment-paid {
            background-color: #d4edda !important;
        }
        .payment-pending {
            background-color: #fff3cd !important;
        }
        .payment-late {
            background-color: #f8d7da !important;
        }
        .badge-status {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        #rfid-result {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .btn-action {
            padding: 5px 10px;
            font-size: 0.85rem;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <h3 class="text-center mb-4">نظام إدارة المدرسة</h3>
                <ul class="nav nav-pills flex-column px-2">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard" id="dashboard-link">
                            <i class="bi bi-speedometer2 me-2"></i>لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="students" id="students-link">
                            <i class="bi bi-people me-2"></i>إدارة الطلاب
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="teachers" id="teachers-link">
                            <i class="bi bi-person-video3 me-2"></i>إدارة الأساتذة
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="classes" id="classes-link">
                            <i class="bi bi-book me-2"></i>إدارة الحصص
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="payments" id="payments-link">
                            <i class="bi bi-cash-coin me-2"></i>المدفوعات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="cards" id="cards-link">
                            <i class="bi bi-credit-card me-2"></i>البطاقات
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="content-section active">
                    <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>لوحة التحكم</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-credit-card me-2"></i>ماسح البطاقات
                                </div>
                                <div class="card-body text-center" id="rfid-result">
                                    <p class="text-muted">قم بتمرير بطاقة الطالب لعرض المعلومات</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-activity me-2"></i>النشاط الأخير
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="recentActivity"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card text-white bg-info">
                                <div class="card-body text-center">
                                    <h5 class="card-title" id="studentsCount">0</h5>
                                    <p class="card-text">عدد الطلاب</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-success">
                                <div class="card-body text-center">
                                    <h5 class="card-title" id="teachersCount">0</h5>
                                    <p class="card-text">عدد الأساتذة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body text-center">
                                    <h5 class="card-title" id="classesCount">0</h5>
                                    <p class="card-text">عدد الحصص</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="students" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-people me-2"></i>إدارة الطلاب</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="bi bi-plus-lg me-1"></i>إضافة طالب
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>رقم الطالب</th>
                                    <th>ولي الأمر</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الحصص</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Teachers Section -->
                <div id="teachers" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-person-video3 me-2"></i>إدارة الأساتذة</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
                            <i class="bi bi-plus-lg me-1"></i>إضافة أستاذ
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>التخصص</th>
                                    <th>الهاتف</th>
                                    <th>تاريخ التعيين</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Classes Section -->
                <div id="classes" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-book me-2"></i>إدارة الحصص</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClassModal">
                            <i class="bi bi-plus-lg me-1"></i>إضافة حصة
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>اسم الحصة</th>
                                    <th>الأستاذ</th>
                                    <th>الوقت</th>
                                    <th>السعر</th>
                                    <th>الطلاب</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="classesTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments" class="content-section">
                    <h2 class="mb-4"><i class="bi bi-cash-coin me-2"></i>إدارة المدفوعات</h2>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="paymentStudentSelect" class="form-label">اختر طالب:</label>
                            <select class="form-select" id="paymentStudentSelect"></select>
                        </div>
                        <div class="col-md-4">
                            <label for="paymentClassSelect" class="form-label">اختر حصة:</label>
                            <select class="form-select" id="paymentClassSelect"></select>
                        </div>
                        <div class="col-md-4">
                            <label for="paymentMonthSelect" class="form-label">اختر شهر:</label>
                            <select class="form-select" id="paymentMonthSelect"></select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>الطالب</th>
                                    <th>الحصة</th>
                                    <th>الشهر</th>
                                    <th>المبلغ</th>
                                    <th>الحالة</th>
                                    <th>تاريخ الدفع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Cards Section -->
                <div id="cards" class="content-section">
                    <h2 class="mb-4"><i class="bi bi-credit-card me-2"></i>إدارة البطاقات</h2>
                    <div class="card mb-4">
                        <div class="card-header">تعيين بطاقة لطالب</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cardStudentSelect" class="form-label">اختر طالب:</label>
                                    <select class="form-select" id="cardStudentSelect"></select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cardUid" class="form-label">رقم البطاقة:</label>
                                    <input type="text" class="form-control" id="cardUid" placeholder="قم بمسح البطاقة">
                                </div>
                            </div>
                            <button class="btn btn-primary" id="assignCardBtn">
                                <i class="bi bi-save me-1"></i>حفظ البطاقة
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>رقم البطاقة</th>
                                    <th>الطالب</th>
                                    <th>تاريخ الإصدار</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="cardsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة طالب جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentName" class="form-label">الاسم الكامل</label>
                                <input type="text" class="form-control" id="studentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="studentId" class="form-label">رقم الطالب</label>
                                <input type="text" class="form-control" id="studentId" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="birthDate" class="form-label">تاريخ الميلاد</label>
                                <input type="date" class="form-control" id="birthDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="registrationDate" class="form-label">تاريخ التسجيل</label>
                                <input type="date" class="form-control" id="registrationDate">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="parentName" class="form-label">اسم ولي الأمر</label>
                                <input type="text" class="form-control" id="parentName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="parentPhone" class="form-label">هاتف ولي الأمر</label>
                                <input type="tel" class="form-control" id="parentPhone">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveStudentBtn">
                        <i class="bi bi-save me-1"></i>حفظ الطالب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة أستاذ جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTeacherForm">
                        <div class="mb-3">
                            <label for="teacherName" class="form-label">الاسم الكامل</label>
                            <input type="text" class="form-control" id="teacherName" required>
                        </div>
                        <div class="mb-3">
                            <label for="specialization" class="form-label">التخصص</label>
                            <input type="text" class="form-control" id="specialization">
                        </div>
                        <div class="mb-3">
                            <label for="teacherPhone" class="form-label">الهاتف</label>
                            <input type="tel" class="form-control" id="teacherPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveTeacherBtn">
                        <i class="bi bi-save me-1"></i>حفظ الأستاذ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة حصة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addClassForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="className" class="form-label">اسم الحصة</label>
                                <input type="text" class="form-control" id="className" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="classPrice" class="form-label">السعر الشهري (درهم)</label>
                                <input type="number" class="form-control" id="classPrice" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="classDescription" class="form-label">الوصف</label>
                            <textarea class="form-control" id="classDescription" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="classDay" class="form-label">اليوم</label>
                                <select class="form-select" id="classDay">
                                    <option value="السبت">السبت</option>
                                    <option value="الأحد">الأحد</option>
                                    <option value="الإثنين">الإثنين</option>
                                    <option value="الثلاثاء">الثلاثاء</option>
                                    <option value="الأربعاء">الأربعاء</option>
                                    <option value="الخميس">الخميس</option>
                                    <option value="الجمعة">الجمعة</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="classTime" class="form-label">الوقت</label>
                                <input type="time" class="form-control" id="classTime">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="classTeacherSelect" class="form-label">الأستاذ</label>
                            <select class="form-select" id="classTeacherSelect"></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveClassBtn">
                        <i class="bi bi-save me-1"></i>حفظ الحصة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تسجيل دفعة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">الطالب</label>
                            <input type="text" class="form-control" id="paymentStudentName" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الحصة</label>
                            <input type="text" class="form-control" id="paymentClassName" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الشهر</label>
                            <input type="text" class="form-control" id="paymentMonth" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">المبلغ (درهم)</label>
                            <input type="number" class="form-control" id="paymentAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">طريقة الدفع</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="cash">نقدي</option>
                                <option value="bank">تحويل بنكي</option>
                                <option value="online">دفع إلكتروني</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">تاريخ الدفع</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn">
                        <i class="bi bi-save me-1"></i>حفظ الدفعة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enroll Student Modal -->
    <div class="modal fade" id="enrollStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة طالب للحصة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="enrollClassSelect" class="form-label">الحصة</label>
                        <select class="form-select" id="enrollClassSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="enrollStudentSelect" class="form-label">الطالب</label>
                        <select class="form-select" id="enrollStudentSelect"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="enrollStudentBtn">
                        <i class="bi bi-save me-1"></i>إضافة الطالب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const socket = io();
        let currentPayment = null;
        let currentClassId = null;
        let currentStudentId = null;

        // Navigation between sections
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remove active from all links
                document.querySelectorAll('.nav-link').forEach(navLink => {
                    navLink.classList.remove('active');
                });
                
                // Activate current link
                this.classList.add('active');
                
                // Show requested section
                const sectionId = this.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                
                // Load data when needed
                if (sectionId === 'students') loadStudents();
                else if (sectionId === 'teachers') loadTeachers();
                else if (sectionId === 'classes') loadClasses();
                else if (sectionId === 'payments') {
                    loadStudentsForPayments();
                    loadPayments();
                }
                else if (sectionId === 'cards') {
                    loadStudentsForCards();
                    loadCards();
                }
            });
        });

        // Handle RFID cards
        socket.on('student-detected', (data) => {
            const rfidResult = document.getElementById('rfid-result');
            const student = data.student;
            
            rfidResult.innerHTML = `
                <div class="card w-100">
                    <div class="card-body text-center">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(student.name)}&background=random&size=100" 
                             class="student-photo mb-3">
                        <h4>${student.name}</h4>
                        <p>رقم الطالب: ${student.studentId}</p>
                        <p>ولي الأمر: ${student.parentName || 'غير مسجل'}</p>
                        <p>الهاتف: ${student.parentPhone || 'غير مسجل'}</p>
                        <hr>
                        <h5>الحصص المسجل بها:</h5>
                        <ul class="list-group mb-3">
                            ${data.classes.map(cls => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${cls.name} (${cls.schedule.day} ${cls.schedule.time})
                                    <span class="badge bg-primary rounded-pill">${cls.price} د.ك</span>
                                </li>
                            `).join('')}
                        </ul>
                        <h5>حالة المدفوعات:</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>الشهر</th>
                                        <th>الحصة</th>
                                        <th>المبلغ</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.payments.map(payment => `
                                        <tr class="${payment.status === 'paid' ? 'table-success' : 
                                                     payment.status === 'pending' ? 'table-warning' : 'table-danger'}">
                                            <td>${payment.month}</td>
                                            <td>${payment.class.name}</td>
                                            <td>${payment.amount} د.ك</td>
                                            <td>
                                                <span class="badge ${payment.status === 'paid' ? 'bg-success' : 
                                                                     payment.status === 'pending' ? 'bg-warning' : 'bg-danger'}">
                                                    ${payment.status === 'paid' ? 'مسدد' : 
                                                     payment.status === 'pending' ? 'قيد الانتظار' : 'متأخر'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to activity log
            const activityItem = document.createElement('li');
            activityItem.className = 'list-group-item';
            activityItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>تم الكشف عن الطالب ${student.name}</span>
                    <small class="text-muted">${new Date().toLocaleTimeString('ar-EG')}</small>
                </div>
            `;
            document.getElementById('recentActivity').prepend(activityItem);
        });

        socket.on('unknown-card', (data) => {
            const rfidResult = document.getElementById('rfid-result');
            rfidResult.innerHTML = `
                <div class="alert alert-warning text-center">
                    <h4>بطاقة غير مسجلة</h4>
                    <p>رقم البطاقة: ${data.uid}</p>
                    <button class="btn btn-primary mt-2" onclick="showAssignCardModal('${data.uid}')">
                        <i class="bi bi-credit-card me-1"></i>تعيين البطاقة لطالب
                    </button>
                </div>
            `;
        });

        socket.on('card-error', (data) => {
            const rfidResult = document.getElementById('rfid-result');
            rfidResult.innerHTML = `
                <div class="alert alert-danger text-center">
                    <h4>حدث خطأ</h4>
                    <p>${data.error}</p>
                </div>
            `;
        });

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();
                
                const tableBody = document.getElementById('studentsTable');
                tableBody.innerHTML = '';
                
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.studentId}</td>
                        <td>${student.parentName || '-'}</td>
                        <td>${new Date(student.registrationDate).toLocaleDateString('ar-EG')}</td>
                        <td>${student.classes?.length || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editStudent('${student._id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteStudent('${student._id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success btn-action" onclick="showEnrollModal('${student._id}')">
                                <i class="bi bi-book"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('studentsCount').textContent = students.length;
            } catch (err) {
                console.error('Error loading students:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات الطلاب', 'error');
            }
        }

        // Load teachers
        async function loadTeachers() {
            try {
                const response = await fetch('/api/teachers');
                const teachers = await response.json();
                
                const tableBody = document.getElementById('teachersTable');
                tableBody.innerHTML = '';
                
                teachers.forEach((teacher, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${teacher.name}</td>
                        <td>${teacher.specialization || '-'}</td>
                        <td>${teacher.phone || '-'}</td>
                        <td>${new Date(teacher.hireDate).toLocaleDateString('ar-EG')}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editTeacher('${teacher._id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteTeacher('${teacher._id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('teachersCount').textContent = teachers.length;
            } catch (err) {
                console.error('Error loading teachers:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات الأساتذة', 'error');
            }
        }

        // Load classes
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes');
                const classes = await response.json();
                
                const tableBody = document.getElementById('classesTable');
                tableBody.innerHTML = '';
                
                classes.forEach((cls, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${cls.name}</td>
                        <td>${cls.teacher?.name || 'غير معين'}</td>
                        <td>${cls.schedule.day} ${cls.schedule.time}</td>
                        <td>${cls.price} د.ك</td>
                        <td>${cls.students?.length || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editClass('${cls._id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteClass('${cls._id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success btn-action" onclick="showClassStudents('${cls._id}')">
                                <i class="bi bi-people"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('classesCount').textContent = classes.length;
            } catch (err) {
                console.error('Error loading classes:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات الحصص', 'error');
            }
        }

        // Load students for payments selection
        async function loadStudentsForPayments() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();
                
                const select = document.getElementById('paymentStudentSelect');
                select.innerHTML = '<option value="" selected disabled>اختر طالب</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student._id;
                    option.textContent = `${student.name} (${student.studentId})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading students for payments:', err);
            }
        }

        // Load classes for payments selection
        async function loadClassesForPayments() {
            try {
                const response = await fetch('/api/classes');
                const classes = await response.json();
                
                const select = document.getElementById('paymentClassSelect');
                select.innerHTML = '<option value="" selected disabled>اختر حصة</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls._id;
                    option.textContent = `${cls.name} (${cls.price} د.ك)`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading classes for payments:', err);
            }
        }

        // Load months for payments selection
        async function loadMonthsForPayments() {
            const select = document.getElementById('paymentMonthSelect');
            select.innerHTML = '<option value="" selected disabled>اختر شهر</option>';
            
            const currentDate = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                
                const option = document.createElement('option');
                option.value = monthStr;
                option.textContent = monthName;
                select.appendChild(option);
            }
        }

        // Load payments
        async function loadPayments(studentId = null, classId = null, month = null) {
            try {
                let url = '/api/payments';
                const params = [];
                
                if (studentId) params.push(`student=${studentId}`);
                if (classId) params.push(`class=${classId}`);
                if (month) params.push(`month=${month}`);
                
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }
                
                const response = await fetch(url);
                const payments = await response.json();
                
                const tableBody = document.getElementById('paymentsTable');
                tableBody.innerHTML = '';
                
                payments.forEach((payment, index) => {
                    const row = document.createElement('tr');
                    row.classList.add(`payment-${payment.status}`);
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${payment.student.name} (${payment.student.studentId})</td>
                        <td>${payment.class.name}</td>
                        <td>${payment.month}</td>
                        <td>${payment.amount} د.ك</td>
                        <td>
                            <span class="badge ${payment.status === 'paid' ? 'bg-success' : 
                                             payment.status === 'pending' ? 'bg-warning' : 'bg-danger'}">
                                ${payment.status === 'paid' ? 'مسدد' : 
                                 payment.status === 'pending' ? 'قيد الانتظار' : 'متأخر'}
                            </span>
                        </td>
                        <td>${payment.paymentDate ? new Date(payment.paymentDate).toLocaleDateString('ar-EG') : '-'}</td>
                        <td>
                            <button class="btn btn-sm ${payment.status !== 'paid' ? 'btn-success' : 'btn-secondary'} btn-action" 
                                onclick="showPaymentModal('${payment._id}')" 
                                ${payment.status === 'paid' ? 'disabled' : ''}>
                                <i class="bi bi-cash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (err) {
                console.error('Error loading payments:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات المدفوعات', 'error');
            }
        }

        // Load students for cards assignment
        async function loadStudentsForCards() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();
                
                const select = document.getElementById('cardStudentSelect');
                select.innerHTML = '<option value="" selected disabled>اختر طالب</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student._id;
                    option.textContent = `${student.name} (${student.studentId})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading students for cards:', err);
            }
        }

        // Load cards
        async function loadCards() {
            try {
                const response = await fetch('/api/cards');
                const cards = await response.json();
                
                const tableBody = document.getElementById('cardsTable');
                tableBody.innerHTML = '';
                
                cards.forEach((card, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${card.uid}</td>
                        <td>${card.student.name} (${card.student.studentId})</td>
                        <td>${new Date(card.issueDate).toLocaleDateString('ar-EG')}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteCard('${card._id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (err) {
                console.error('Error loading cards:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات البطاقات', 'error');
            }
        }

        // Add new student
        document.getElementById('saveStudentBtn').addEventListener('click', async () => {
            const studentData = {
                name: document.getElementById('studentName').value,
                studentId: document.getElementById('studentId').value,
                birthDate: document.getElementById('birthDate').value,
                parentName: document.getElementById('parentName').value,
                parentPhone: document.getElementById('parentPhone').value,
                registrationDate: document.getElementById('registrationDate').value || new Date()
            };
            
            try {
                const response = await fetch('/api/students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(studentData)
                });
                
                if (response.ok) {
                    Swal.fire('نجاح', 'تم إضافة الطالب بنجاح', 'success');
                    document.getElementById('addStudentForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    loadStudents();
                    loadStudentsForPayments();
                    loadStudentsForCards();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء إضافة الطالب', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // Add new teacher
        document.getElementById('saveTeacherBtn').addEventListener('click', async () => {
            const teacherData = {
                name: document.getElementById('teacherName').value,
                specialization: document.getElementById('specialization').value,
                phone: document.getElementById('teacherPhone').value
            };
            
            try {
                const response = await fetch('/api/teachers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(teacherData)
                });
                
                if (response.ok) {
                    Swal.fire('نجاح', 'تم إضافة الأستاذ بنجاح', 'success');
                    document.getElementById('addTeacherForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
                    loadTeachers();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء إضافة الأستاذ', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // Add new class
        document.getElementById('saveClassBtn').addEventListener('click', async () => {
            const classData = {
                name: document.getElementById('className').value,
                description: document.getElementById('classDescription').value,
                schedule: {
                    day: document.getElementById('classDay').value,
                    time: document.getElementById('classTime').value
                },
                price: document.getElementById('classPrice').value,
                teacher: document.getElementById('classTeacherSelect').value
            };
            
            try {
                const response = await fetch('/api/classes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(classData)
                });
                
                if (response.ok) {
                    Swal.fire('نجاح', 'تم إضافة الحصة بنجاح', 'success');
                    document.getElementById('addClassForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addClassModal')).hide();
                    loadClasses();
                    loadClassesForPayments();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء إضافة الحصة', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // Assign card to student
        document.getElementById('assignCardBtn').addEventListener('click', async () => {
            const studentId = document.getElementById('cardStudentSelect').value;
            const cardUid = document.getElementById('cardUid').value;
            
            if (!studentId || !cardUid) {
                Swal.fire('خطأ', 'يجب اختيار طالب ومسح البطاقة', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/cards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uid: cardUid,
                        student: studentId
                    })
                });
                
                if (response.ok) {
                    Swal.fire('نجاح', 'تم تعيين البطاقة للطالب بنجاح', 'success');
                    document.getElementById('cardUid').value = '';
                    loadCards();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء تعيين البطاقة', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // Register payment
        document.getElementById('savePaymentBtn').addEventListener('click', async () => {
            if (!currentPayment) return;
            
            const paymentData = {
                amount: document.getElementById('paymentAmount').value,
                paymentDate: document.getElementById('paymentDate').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                status: 'paid'
            };
            
            try {
                const response = await fetch(`/api/payments/${currentPayment._id}/pay`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    Swal.fire('نجاح', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    loadPayments();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء تسجيل الدفعة', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // Enroll student in class
        document.getElementById('enrollStudentBtn').addEventListener('click', async () => {
            const classId = document.getElementById('enrollClassSelect').value;
            const studentId = document.getElementById('enrollStudentSelect').value;
            
            if (!classId || !studentId) {
                Swal.fire('خطأ', 'يجب اختيار حصة وطالب', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/classes/${classId}/enroll/${studentId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show generated payments
                    const paymentsHtml = result.payments.map(payment => `
                        <tr class="${payment.status === 'paid' ? 'table-success' : 
                                     payment.status === 'pending' ? 'table-warning' : 'table-danger'}">
                            <td>${payment.month}</td>
                            <td>${payment.amount} د.ك</td>
                            <td>
                                <span class="badge ${payment.status === 'paid' ? 'bg-success' : 
                                                 payment.status === 'pending' ? 'bg-warning' : 'bg-danger'}">
                                    ${payment.status === 'paid' ? 'مسدد' : 
                                     payment.status === 'pending' ? 'قيد الانتظار' : 'متأخر'}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                    
                    Swal.fire({
                        title: 'تمت العملية بنجاح',
                        html: `
                            <p>${result.message}</p>
                            <h5 class="mt-3">الدفعات الشهرية:</h5>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>الشهر</th>
                                            <th>المبلغ</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>${paymentsHtml}</tbody>
                                </table>
                            </div>
                        `,
                        icon: 'success'
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('enrollStudentModal')).hide();
                    loadClasses();
                    loadStudents();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error || 'حدث خطأ أثناء إضافة الطالب للحصة', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء الاتصال بالخادم', 'error');
            }
        });

        // When student selection changes in payments section
        document.getElementById('paymentStudentSelect').addEventListener('change', function() {
            loadPayments(this.value, 
                        document.getElementById('paymentClassSelect').value,
                        document.getElementById('paymentMonthSelect').value);
        });

        // When class selection changes in payments section
        document.getElementById('paymentClassSelect').addEventListener('change', function() {
            loadPayments(document.getElementById('paymentStudentSelect').value,
                        this.value,
                        document.getElementById('paymentMonthSelect').value);
        });

        // When month selection changes in payments section
        document.getElementById('paymentMonthSelect').addEventListener('change', function() {
            loadPayments(document.getElementById('paymentStudentSelect').value,
                        document.getElementById('paymentClassSelect').value,
                        this.value);
        });

        // Show payment modal
        window.showPaymentModal = async function(paymentId) {
            try {
                const response = await fetch(`/api/payments/${paymentId}`);
                const payment = await response.json();
                
                if (response.ok) {
                    currentPayment = payment;
                    
                    document.getElementById('paymentStudentName').value = payment.student.name;
                    document.getElementById('paymentClassName').value = payment.class.name;
                    document.getElementById('paymentMonth').value = payment.month;
                    document.getElementById('paymentAmount').value = payment.amount;
                    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                    
                    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                    paymentModal.show();
                } else {
                    const error = await response.json();
                    Swal.fire('خطأ', error.error, 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء جلب بيانات الدفعة', 'error');
            }
        };

        // Show enroll student modal
        window.showEnrollModal = async function(studentId) {
            currentStudentId = studentId;
            
            try {
                // Load available classes
                const response = await fetch('/api/classes');
                const classes = await response.json();
                
                const select = document.getElementById('enrollClassSelect');
                select.innerHTML = '<option value="" selected disabled>اختر حصة</option>';
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls._id;
                    option.textContent = `${cls.name} (${cls.schedule.day} ${cls.schedule.time})`;
                    select.appendChild(option);
                });
                
                // Set selected student
                const studentResponse = await fetch(`/api/students/${studentId}`);
                const student = await studentResponse.json();
                
                document.getElementById('enrollStudentSelect').innerHTML = `
                    <option value="${student._id}" selected>${student.name} (${student.studentId})</option>
                `;
                
                const enrollModal = new bootstrap.Modal(document.getElementById('enrollStudentModal'));
                enrollModal.show();
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء تحميل بيانات الحصص', 'error');
            }
        };

        // Show assign card modal
        window.showAssignCardModal = function(uid) {
            document.getElementById('cardUid').value = uid;
            document.getElementById('cards-link').click();
            document.getElementById('cardStudentSelect').focus();
        };

        // Show class students
        window.showClassStudents = async function(classId) {
            currentClassId = classId;
            
            try {
                const response = await fetch(`/api/classes/${classId}`);
                const classObj = await response.json();
                
                // Get students data
                const students = await Promise.all(
                    classObj.students.map(studentId => 
                        fetch(`/api/students/${studentId}`).then(res => res.json())
                    )
                );
                
                // Get payments data
                const paymentsResponse = await fetch(`/api/payments?class=${classId}`);
                const payments = await paymentsResponse.json();
                
                // Create HTML for display
                const studentsHtml = students.map(student => {
                    const studentPayments = payments.filter(p => p.student._id === student._id);
                    
                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>${student.name} (${student.studentId})</h5>
                                    <button class="btn btn-sm btn-danger" onclick="unenrollStudent('${classId}', '${student._id}')">
                                        <i class="bi bi-trash"></i> إزالة
                                    </button>
                                </div>
                                <p>ولي الأمر: ${student.parentName || 'غير مسجل'}</p>
                                <h6>حالة المدفوعات:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>الشهر</th>
                                                <th>المبلغ</th>
                                                <th>الحالة</th>
                                                <th>إجراء</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentPayments.map(payment => `
                                                <tr class="${payment.status === 'paid' ? 'table-success' : 
                                                             payment.status === 'pending' ? 'table-warning' : 'table-danger'}">
                                                    <td>${payment.month}</td>
                                                    <td>${payment.amount} د.ك</td>
                                                    <td>
                                                        <span class="badge ${payment.status === 'paid' ? 'bg-success' : 
                                                                         payment.status === 'pending' ? 'bg-warning' : 'bg-danger'}">
                                                            ${payment.status === 'paid' ? 'مسدد' : 
                                                             payment.status === 'pending' ? 'قيد الانتظار' : 'متأخر'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm ${payment.status !== 'paid' ? 'btn-success' : 'btn-secondary'}" 
                                                            onclick="showPaymentModal('${payment._id}')" 
                                                            ${payment.status === 'paid' ? 'disabled' : ''}>
                                                            <i class="bi bi-cash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                Swal.fire({
                    title: `طلاب حصة ${classObj.name}`,
                    html: studentsHtml,
                    width: '800px',
                    showConfirmButton: false,
                    showCloseButton: true
                });
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء جلب بيانات الطلاب', 'error');
            }
        };

        // Unenroll student from class
        window.unenrollStudent = async function(classId, studentId) {
            try {
                const { isConfirmed } = await Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: 'سيتم إزالة الطالب من الحصة وحذف مدفوعاته',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، إزالة',
                    cancelButtonText: 'إلغاء'
                });
                
                if (isConfirmed) {
                    const response = await fetch(`/api/classes/${classId}/unenroll/${studentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        Swal.fire('نجاح', 'تم إزالة الطالب من الحصة بنجاح', 'success');
                        showClassStudents(classId);
                        loadClasses();
                        loadStudents();
                    } else {
                        const error = await response.json();
                        Swal.fire('خطأ', error.error, 'error');
                    }
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء إزالة الطالب', 'error');
            }
        };

        // Delete student
        window.deleteStudent = async function(studentId) {
            try {
                const { isConfirmed } = await Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: 'سيتم حذف الطالب وكل بياناته المرتبطة',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، احذف',
                    cancelButtonText: 'إلغاء'
                });
                
                if (isConfirmed) {
                    const response = await fetch(`/api/students/${studentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        Swal.fire('نجاح', 'تم حذف الطالب بنجاح', 'success');
                        loadStudents();
                        loadStudentsForPayments();
                        loadStudentsForCards();
                    } else {
                        const error = await response.json();
                        Swal.fire('خطأ', error.error, 'error');
                    }
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء حذف الطالب', 'error');
            }
        };

        // Delete teacher
        window.deleteTeacher = async function(teacherId) {
            try {
                const { isConfirmed } = await Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: 'سيتم حذف الأستاذ وكل بياناته المرتبطة',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، احذف',
                    cancelButtonText: 'إلغاء'
                });
                
                if (isConfirmed) {
                    const response = await fetch(`/api/teachers/${teacherId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        Swal.fire('نجاح', 'تم حذف الأستاذ بنجاح', 'success');
                        loadTeachers();
                    } else {
                        const error = await response.json();
                        Swal.fire('خطأ', error.error, 'error');
                    }
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء حذف الأستاذ', 'error');
            }
        };

        // Delete class
        window.deleteClass = async function(classId) {
            try {
                const { isConfirmed } = await Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: 'سيتم حذف الحصة وكل البيانات المرتبطة بها',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، احذف',
                    cancelButtonText: 'إلغاء'
                });
                
                if (isConfirmed) {
                    const response = await fetch(`/api/classes/${classId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        Swal.fire('نجاح', 'تم حذف الحصة بنجاح', 'success');
                        loadClasses();
                        loadClassesForPayments();
                    } else {
                        const error = await response.json();
                        Swal.fire('خطأ', error.error, 'error');
                    }
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء حذف الحصة', 'error');
            }
        };

        // Delete card
        window.deleteCard = async function(cardId) {
            try {
                const { isConfirmed } = await Swal.fire({
                    title: 'هل أنت متأكد؟',
                    text: 'سيتم حذف البطاقة ولن يتم التعرف على الطالب عند مسحها',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، احذف',
                    cancelButtonText: 'إلغاء'
                });
                
                if (isConfirmed) {
                    const response = await fetch(`/api/cards/${cardId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        Swal.fire('نجاح', 'تم حذف البطاقة بنجاح', 'success');
                        loadCards();
                    } else {
                        const error = await response.json();
                        Swal.fire('خطأ', error.error, 'error');
                    }
                }
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('خطأ', 'حدث خطأ أثناء حذف البطاقة', 'error');
            }
        };

        // Initial setup
        document.addEventListener('DOMContentLoaded', async () => {
            // Load initial data
            await loadStudents();
            await loadTeachers();
            await loadClasses();
            await loadStudentsForPayments();
            await loadClassesForPayments();
            await loadMonthsForPayments();
            await loadStudentsForCards();
            await loadCards();
            
            // Load teachers for class selection
            const teachersResponse = await fetch('/api/teachers');
            const teachers = await teachersResponse.json();
            
            const teacherSelect = document.getElementById('classTeacherSelect');
            teacherSelect.innerHTML = '<option value="" selected disabled>اختر أستاذ</option>';
            
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher._id;
                option.textContent = `${teacher.name} (${teacher.specialization || 'بدون تخصص'})`;
                teacherSelect.appendChild(option);
            });
            
            // Set today's date as default registration date
            document.getElementById('registrationDate').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>